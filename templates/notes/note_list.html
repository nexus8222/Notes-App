{% extends "base.html" %}
{% block content %}
<form method="post" action="{% url 'note_list' %}">
  {% csrf_token %}
  <div class="d-flex align-items-center mb-3 p-2 rounded" style="background-color: #333;">
    <div class="form-check me-3">
      <input class="form-check-input" type="checkbox" id="select-all-checkbox">
      <label class="form-check-label" for="select-all-checkbox">Select All</label>
    </div>
    <button type="submit" id="delete-selected-btn" class="btn btn-danger btn-sm" disabled>
      <i class="fas fa-trash-alt"></i> Delete Selected
    </button>
  </div>
  <div class="row">
    {% for n in notes %}
    <div class="col-md-4 mb-3">
      <div class="card h-100 shadow-sm position-relative">
        
        <!-- MODIFIED - Checkbox for each note -->
        <div class="form-check position-absolute" style="top: 0.5rem; right: 0.5rem; z-index: 10;">
          <input 
            class="form-check-input note-checkbox" 
            type="checkbox" 
            name="selected_notes" 
            value="{{ n.id }}"
            aria-label="Select note {{ n.title }}"
            {% if n.password %}
              disabled
              title="Password-protected notes cannot be bulk-deleted."
            {% endif %}
          >
        </div>

        <div class="card-body">
          <h5 class="card-title d-flex justify-content-between align-items-center">
            <span class="me-2">{{ n.title }}</span>
            <div>
              {% if n.password %}
                <i class="fas fa-lock text-warning me-2" title="Password Protected"></i>
              {% endif %}
              {% if n.is_pinned %}
                <i class="fas fa-thumbtack text-info" title="Pinned"></i>
              {% endif %}
            </div>
          </h5>
          <p class="card-text text-truncate" style="max-height:4.5rem;">{{ n.content }}</p>
          <a href="{% url 'note_detail' n.id %}" class="stretched-link"></a>
        </div>
        <div class="card-footer small text-muted">
          {% for tag in n.tags %}
            <span class="badge bg-secondary me-1">{{ tag }}</span>
          {% endfor %}
        </div>
      </div>
    </div>
    {% empty %}
    <p class="text-center">No notes yet. Create one!</p>
    {% endfor %}
  </div>
</form>

<!-- MODIFIED - JavaScript to ignore disabled checkboxes -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const selectAllCheckbox = document.getElementById('select-all-checkbox');
  // Only select checkboxes that are NOT disabled
  const noteCheckboxes = document.querySelectorAll('.note-checkbox:not(:disabled)');
  const deleteBtn = document.getElementById('delete-selected-btn');

  function updateDeleteButtonState() {
    const anyChecked = document.querySelectorAll('.note-checkbox:checked:not(:disabled)').length > 0;
    deleteBtn.disabled = !anyChecked;
  }

  selectAllCheckbox.addEventListener('change', function () {
    noteCheckboxes.forEach(checkbox => {
      checkbox.checked = selectAllCheckbox.checked;
    });
    updateDeleteButtonState();
  });

  noteCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function () {
      if (!this.checked) {
        selectAllCheckbox.checked = false;
      }
      updateDeleteButtonState();
    });
  });

  updateDeleteButtonState();
});
</script>
{% endblock %}
